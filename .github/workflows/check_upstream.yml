name: Check Upstream Updates

on:
  schedule:
    - cron: '0 9 * * 5' # ูู ุฌูุนุฉ
  workflow_dispatch: # ุชุดุบูู ูุฏูู

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Add Upstream & Fetch
        run: |
          git remote add upstream https://github.com/MobSF/Mobile-Security-Framework-MobSF.git
          git fetch upstream master

      - name: Generate Full Report
        id: report
        run: |
          # ุญุณุงุจ ุนุฏุฏ ุงูุชุบููุฑุงุช
          COUNT=$(git rev-list HEAD..upstream/master --count)
          
          echo "New Commits Count: $COUNT"
          
          if [ "$COUNT" -gt "0" ]; then
            echo "UPDATES_FOUND=true" >> $GITHUB_ENV
            
            # --- ุงูุชุบููุฑ ููุง: ุฌูุจ ูุงุฆูุฉ ุจุฃุณูุงุก ูู ุงููููุงุช ุงูุชู ุชุบูุฑุช ---
            echo "FILES_CHANGED<<EOF" >> $GITHUB_ENV
            git diff --name-only HEAD..upstream/master >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # ุฌูุจ ุฑุณุงุฆู ุงูุชุนุฏููุงุช (ุนูุงููู ุงูููููุชุงุช)
            echo "COMMIT_LOG<<EOF" >> $GITHUB_ENV
            git log HEAD..upstream/master --pretty=format:"- %s (%an)" --no-merges -n 50 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "UPDATES_FOUND=false" >> $GITHUB_ENV
          fi

      - name: Send Email Notification
        if: env.UPDATES_FOUND == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: ๐จ Full MobSF Update Report
          to: ammarragha@gmail.com # <--- ุชุฃูุฏ ูู ูุชุงุจุฉ ุฅููููู ููุง
          from: MobSF Watcher
          body: |
            New updates detected in the official MobSF repository.
            
            ---------------------------------------------------
            LIST OF ALL CHANGED FILES:
            ---------------------------------------------------
            ${{ env.FILES_CHANGED }}
            
            ---------------------------------------------------
            COMMIT MESSAGES:
            ---------------------------------------------------
            ${{ env.COMMIT_LOG }}
            
            ---------------------------------------------------
            Check the repo for details.
