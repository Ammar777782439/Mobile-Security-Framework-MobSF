name: Check Upstream Updates

on:
  schedule:
    # ÙŠØ¹Ù…Ù„ ÙƒÙ„ ÙŠÙˆÙ… Ø¬Ù…Ø¹Ø© Ø§Ù„Ø³Ø§Ø¹Ø© 9 ØµØ¨Ø§Ø­Ø§Ù‹
    - cron: '0 9 * * 5'
  workflow_dispatch: # ÙŠØ³Ù…Ø­ Ù„Ùƒ Ø¨ØªØ´ØºÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¨Ø¶ØºØ·Ø© Ø²Ø± Ù„Ù„ØªØ¬Ø±Ø¨Ø© Ø§ 

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®

      - name: Add Upstream & Fetch
        run: |
          git remote add upstream https://github.com/MobSF/Mobile-Security-Framework-MobSF.git
          git fetch upstream master

      - name: Generate Report
        id: report
        run: |
          # 1. Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆÙ…ÙŠØªØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          COUNT=$(git rev-list HEAD..upstream/master --count)
          
          echo "New Commits: $COUNT"
          
          if [ "$COUNT" -gt "0" ]; then
            echo "UPDATES_FOUND=true" >> $GITHUB_ENV
            
            # 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© (Ø¹Ø´Ø§Ù† ØªØ¹Ø±Ù Ù„Ùˆ Ù„Ù…Ø³ÙˆØ§ Ù…Ù„ÙØ§ØªÙƒ)
            echo "FILES_CHANGED<<EOF" >> $GITHUB_ENV
            git diff --stat HEAD..upstream/master >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            # 3. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª (Commits Messages)
            echo "COMMIT_LOG<<EOF" >> $GITHUB_ENV
            git log HEAD..upstream/master --pretty=format:"- %h: %s (%an)" --no-merges -n 20 >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "UPDATES_FOUND=false" >> $GITHUB_ENV
          fi

      - name: Send Email Notification
        if: env.UPDATES_FOUND == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: ğŸš¨ MobSF Upstream Updates Detected!
          to: your_email@example.com # Ø¶Ø¹ Ø¥ÙŠÙ…ÙŠÙ„Ùƒ Ù‡Ù†Ø§
          from: MobSF Watcher
          body: |
            There are updates in the official MobSF repository!
            
            ---------------------------------------------------
            FILES CHANGED (Check if your modified files are here):
            ---------------------------------------------------
            ${{ env.FILES_CHANGED }}
            
            ---------------------------------------------------
            LATEST COMMITS (What they added):
            ---------------------------------------------------
            ${{ env.COMMIT_LOG }}
            
            ---------------------------------------------------
            Action Required: Run 'git fetch upstream' and review changes.
